#!/usr/bin/env node
 // -*- mode: javascript; -*-

"use strict";

var program = require('commander');
var rest = require('restler');
var tools = require('./tools');
var DEFAULT_HEARTBEAT = 300;

program
  .command("list")
  .description("List all products")
  .action(function(opts) {
    rest.get(tools.urlProducts(), tools.getAuthObj())
      .on('success', function(data, response) {
        if (data.length > 0) {
          console.log("Products:");
          tools.printJsonArray(data);
        } else {
          console.log("No products.");
        }
      }).on('fail', tools.failureHandler);
  });

program
  .command("create <name> [heartbeat]")
  .description("Create new product")
  .action(function(name, heartbeat, opts) {
    var heartbeat = heartbeat ? heartbeat : DEFAULT_HEARTBEAT;

    rest.postJson(tools.urlProducts(), {
        name: name,
        heartbeat: heartbeat
      }, tools.getAuthObj())
      .on('success', function(data, response) {
        console.log("New product created:");
        tools.printJson(data);
      }).on('fail', tools.failureHandler);
  });

program
  .command("update <productName> <heartbeat>")
  .description("Update heartbeat for product")
  .action(function(productName, heartbeat, opts) {
    tools.doForProductName(productName, function(productId) {
      rest.putJson(tools.urlProduct(productId), {
          "heartbeat": heartbeat
        }, tools.getAuthObj())
        .on('success', function(data, response) {
          console.log("Product " + productName + " updated.");
        })
        .on('fail', tools.failureHandler);
    });
  });

program
  .command("delete <productName>")
  .description("Delete single product")
  .action(function(productName, opts) {
    tools.doForProductName(productName, function(productId) {
      rest.del(tools.urlProduct(productId), tools.getAuthObj())
        .on('success', function(data, response) {
          console.log("Product " + productName + " deleted.");
        })
        .on('fail', tools.failureHandler);
    });
  });

program
  .command("meta <productName>")
  .description("List all metadata for given product")
  .action(function(productName, opts) {

    tools.doForProductName(productName, function(productId) {
      rest.get(tools.urlProductMeta(productId), tools.getAuthObj())
        .on('success', function(data, response) {
          if (data.length > 0) {
            tools.printJsonArray(data);
          } else {
            console.log("No meta.");
          }
        }).on('fail', tools.failureHandler);
    });

  });

program
  .command("meta-add <productName> <key> <value>")
  .description("Create or update product metadata entry")
  .action(function(productName, key, value) {
    var metadataJson = {
      "key": key,
      "value": value
    };

    tools.doForProductName(productName, function(productId) {
      rest.putJson(tools.urlProductMeta(productId), metadataJson, tools.getAuthObj())
        .on('success', function(data, response) {
          console.log("Metadata added.");
        })
        .on('fail', tools.failureHandler);
    });
  });

program
  .command("meta-delete <productName> <key>")
  .description("Delete single product's metadata entry")
  .action(function(productName, key, opts) {

    tools.doForProductName(productName, function(productId) {
      rest.del(tools.urlProductMetaKey(productId, key), tools.getAuthObj())
        .on('success', function(data, response) {
          console.log('Key ' + key + ' deleted for product ' + productName + '.');
        }).on('fail', tools.failureHandler);
    });
  });

program.parse(process.argv);
if (!program.args.length) {
  program.help();
}
